import AppBar from "@mui/material/AppBar";
import { useState, useContext, useRef, useEffect } from "react";
import HomeIcon from "@mui/icons-material/Home";
import {
  Select,
  MenuItem,
  Switch,
  Toolbar,
  Button,
  MenuList,
  Popper,
  ClickAwayListener,
  Paper,
  Grow,
  IconButton,
} from "@mui/material";
import { Container } from "@mui/system";
import { useNavigate } from "react-router-dom";
import { useCookies } from "react-cookie";
import axios from "axios";
import { AppContext } from "../App";
import { clearStorage } from "../middleware/Auth";

export default function NavBar() {
  const [open, setOpen] = useState(false);
  const token = localStorage.getItem("token");
  const anchorRef = useRef(null);

  const handleToggle = () => {
    setOpen((prevOpen) => !prevOpen);
  };

  const handleClose = (event) => {
    if (anchorRef.current && anchorRef.current.contains(event.target)) {
      return;
    }

    setOpen(false);
  };

  function handleListKeyDown(event) {
    if (event.key === "Tab") {
      event.preventDefault();
      setOpen(false);
    } else if (event.key === "Escape") {
      setOpen(false);
    }
  }

  // return focus to the button when we transitioned from !open -> open
  const prevOpen = useRef(open);
  useEffect(() => {
    if (prevOpen.current === true && open === false) {
      anchorRef.current.focus();
    }

    prevOpen.current = open;
  }, [open]);

  const {
    toggle,
    setToggle,
    semesterId,
    setSemesterId,
  } = useContext(AppContext);

  const handleOnChangeToggle = (event) => {
    const isChecked = event.target.checked;
    setToggle(isChecked);
    localStorage.setItem("projectPath", isChecked ? "project" : "proposal");
  };

  const handleOnChangeSemester = (event) => {
    const semId = event.target.value;
    setSemesterId(semId);
    localStorage.setItem("semesterId", semId);
  };

  let navigate = useNavigate();

  const signOut = () => {
    handleClose;
    navigate("/main");
    clearStorage();
  };

  return (
    <AppBar position="sticky">
      <Container maxWidth="xl">
        <Toolbar disableGutters>
          <IconButton onClick={() => navigate("/")}>
            {/* <HomeIcon sx={{ width: 32, height: 32, color: "#0075FF" }} /> */}
            <svg
              width="44"
              height="34"
              viewBox="0 0 66 51"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M1.60835 28.7023L2.88635 30.8683L4.16435 28.7023L4.45835 31.2583H5.19035L4.61435 26.8483L2.88635 29.6983L1.16435 26.8483L0.588352 31.2583H1.32035L1.60835 28.7023ZM8.18196 30.1783H10.402L10.264 29.5783H8.31396L8.18196 30.1783ZM9.27996 28.2463L9.94596 29.8063L9.96396 29.9803L10.534 31.2583H11.332L9.27996 26.8243L7.22796 31.2583H8.02596L8.60796 29.9443L8.61996 29.7883L9.27996 28.2463ZM13.1994 27.7123H14.3034V31.2583H15.0174V27.7123H16.1274V27.0583H13.1994V27.7123ZM18.7236 29.3323H21.7176V28.6783H18.7236V29.3323ZM21.2616 27.0583V31.2583H21.9696V27.0583H21.2616ZM18.4416 27.0583V31.2583H19.1496V27.0583H18.4416ZM25.5753 28.9843L27.5973 31.2583H28.3593L26.1393 28.7683C26.0033 28.6123 25.8813 28.4743 25.7733 28.3543C25.6693 28.2303 25.6173 28.1043 25.6173 27.9763C25.6173 27.8443 25.6573 27.7363 25.7373 27.6523C25.8213 27.5643 25.9393 27.5203 26.0913 27.5203C26.1913 27.5203 26.2753 27.5423 26.3433 27.5863C26.4113 27.6263 26.4633 27.6803 26.4993 27.7483C26.5393 27.8163 26.5593 27.8943 26.5593 27.9823C26.5593 28.1063 26.4973 28.2363 26.3733 28.3723C26.2493 28.5043 26.0753 28.6303 25.8513 28.7503C25.7673 28.7903 25.6653 28.8363 25.5453 28.8883C25.4293 28.9403 25.3093 29.0023 25.1853 29.0743C25.0613 29.1423 24.9453 29.2263 24.8373 29.3263C24.7333 29.4263 24.6473 29.5443 24.5793 29.6803C24.5113 29.8123 24.4773 29.9683 24.4773 30.1483C24.4773 30.3923 24.5413 30.6023 24.6693 30.7783C24.8013 30.9543 24.9733 31.0903 25.1853 31.1863C25.3973 31.2783 25.6253 31.3243 25.8693 31.3243C26.1493 31.3243 26.4073 31.2743 26.6433 31.1743C26.8793 31.0743 27.0973 30.9443 27.2973 30.7843C27.4973 30.6203 27.6813 30.4383 27.8493 30.2383C28.0213 30.0343 28.1813 29.8303 28.3293 29.6263L27.8613 29.3023C27.7253 29.4943 27.5833 29.6783 27.4353 29.8543C27.2873 30.0263 27.1333 30.1803 26.9733 30.3163C26.8133 30.4483 26.6473 30.5543 26.4753 30.6343C26.3033 30.7143 26.1253 30.7543 25.9413 30.7543C25.7893 30.7543 25.6553 30.7283 25.5393 30.6763C25.4233 30.6203 25.3313 30.5423 25.2633 30.4423C25.1953 30.3423 25.1613 30.2283 25.1613 30.1003C25.1613 29.9603 25.1953 29.8423 25.2633 29.7463C25.3353 29.6463 25.4273 29.5603 25.5393 29.4883C25.6513 29.4163 25.7693 29.3503 25.8933 29.2903C26.0173 29.2303 26.1333 29.1663 26.2413 29.0983C26.3933 29.0063 26.5273 28.9163 26.6433 28.8283C26.7593 28.7403 26.8573 28.6503 26.9373 28.5583C27.0173 28.4663 27.0773 28.3703 27.1173 28.2703C27.1613 28.1703 27.1833 28.0623 27.1833 27.9463C27.1833 27.7783 27.1393 27.6223 27.0513 27.4783C26.9673 27.3303 26.8433 27.2103 26.6793 27.1183C26.5193 27.0263 26.3233 26.9803 26.0913 26.9803C25.8673 26.9803 25.6693 27.0223 25.4973 27.1063C25.3293 27.1903 25.1973 27.3063 25.1013 27.4543C25.0093 27.6023 24.9633 27.7683 24.9633 27.9523C24.9633 28.1003 24.9973 28.2363 25.0653 28.3603C25.1373 28.4843 25.2213 28.5983 25.3173 28.7023C25.4133 28.8023 25.4993 28.8963 25.5753 28.9843ZM31.2625 29.1583C31.2625 28.8583 31.3285 28.5983 31.4605 28.3783C31.5965 28.1543 31.7725 27.9823 31.9885 27.8623C32.2085 27.7383 32.4465 27.6763 32.7025 27.6763C32.9025 27.6763 33.0825 27.7023 33.2425 27.7543C33.4025 27.8063 33.5465 27.8783 33.6745 27.9703C33.8065 28.0583 33.9205 28.1583 34.0165 28.2703V27.4303C33.8405 27.2863 33.6505 27.1763 33.4465 27.1003C33.2425 27.0243 32.9865 26.9863 32.6785 26.9863C32.3705 26.9863 32.0825 27.0383 31.8145 27.1423C31.5505 27.2463 31.3205 27.3963 31.1245 27.5923C30.9285 27.7883 30.7745 28.0203 30.6625 28.2883C30.5545 28.5523 30.5005 28.8423 30.5005 29.1583C30.5005 29.4743 30.5545 29.7663 30.6625 30.0343C30.7745 30.2983 30.9285 30.5283 31.1245 30.7243C31.3205 30.9203 31.5505 31.0703 31.8145 31.1743C32.0825 31.2783 32.3705 31.3303 32.6785 31.3303C32.9865 31.3303 33.2425 31.2923 33.4465 31.2163C33.6505 31.1403 33.8405 31.0303 34.0165 30.8863V30.0463C33.9205 30.1583 33.8065 30.2603 33.6745 30.3523C33.5465 30.4403 33.4025 30.5103 33.2425 30.5623C33.0825 30.6143 32.9025 30.6403 32.7025 30.6403C32.4465 30.6403 32.2085 30.5803 31.9885 30.4603C31.7725 30.3363 31.5965 30.1623 31.4605 29.9383C31.3285 29.7143 31.2625 29.4543 31.2625 29.1583ZM37.1977 29.1583C37.1977 28.8703 37.2577 28.6143 37.3777 28.3903C37.5017 28.1623 37.6717 27.9843 37.8877 27.8563C38.1037 27.7283 38.3497 27.6643 38.6257 27.6643C38.9097 27.6643 39.1577 27.7283 39.3697 27.8563C39.5857 27.9843 39.7537 28.1623 39.8737 28.3903C39.9937 28.6143 40.0537 28.8703 40.0537 29.1583C40.0537 29.4463 39.9917 29.7043 39.8677 29.9323C39.7477 30.1563 39.5797 30.3323 39.3637 30.4603C39.1517 30.5883 38.9057 30.6523 38.6257 30.6523C38.3497 30.6523 38.1037 30.5883 37.8877 30.4603C37.6717 30.3323 37.5017 30.1563 37.3777 29.9323C37.2577 29.7043 37.1977 29.4463 37.1977 29.1583ZM36.4477 29.1583C36.4477 29.4703 36.5017 29.7603 36.6097 30.0283C36.7177 30.2963 36.8677 30.5283 37.0597 30.7243C37.2557 30.9203 37.4877 31.0743 37.7557 31.1863C38.0237 31.2943 38.3137 31.3483 38.6257 31.3483C38.9417 31.3483 39.2317 31.2943 39.4957 31.1863C39.7637 31.0743 39.9957 30.9203 40.1917 30.7243C40.3877 30.5283 40.5397 30.2963 40.6477 30.0283C40.7557 29.7603 40.8097 29.4703 40.8097 29.1583C40.8097 28.8423 40.7557 28.5523 40.6477 28.2883C40.5397 28.0243 40.3857 27.7963 40.1857 27.6043C39.9897 27.4083 39.7597 27.2563 39.4957 27.1483C39.2317 27.0403 38.9417 26.9863 38.6257 26.9863C38.3177 26.9863 38.0297 27.0403 37.7617 27.1483C37.4977 27.2563 37.2657 27.4083 37.0657 27.6043C36.8697 27.7963 36.7177 28.0243 36.6097 28.2883C36.5017 28.5523 36.4477 28.8423 36.4477 29.1583ZM44.0771 28.7023L45.3551 30.8683L46.6331 28.7023L46.9271 31.2583H47.6591L47.0831 26.8483L45.3551 29.6983L43.6331 26.8483L43.0571 31.2583H43.7891L44.0771 28.7023ZM49.7087 30.1243H50.9387V29.5423H49.7087V30.1243ZM53.5106 29.9083L52.9826 30.2743C53.0746 30.4663 53.1986 30.6443 53.3546 30.8083C53.5106 30.9723 53.6926 31.1043 53.9006 31.2043C54.1126 31.3003 54.3426 31.3483 54.5906 31.3483C54.7706 31.3483 54.9426 31.3183 55.1066 31.2583C55.2746 31.2023 55.4246 31.1223 55.5566 31.0183C55.6886 30.9103 55.7926 30.7783 55.8686 30.6223C55.9446 30.4663 55.9826 30.2903 55.9826 30.0943C55.9826 29.9103 55.9506 29.7503 55.8866 29.6143C55.8266 29.4783 55.7446 29.3603 55.6406 29.2603C55.5366 29.1563 55.4206 29.0703 55.2926 29.0023C55.1686 28.9343 55.0446 28.8783 54.9206 28.8343C54.6966 28.7543 54.5146 28.6763 54.3746 28.6003C54.2346 28.5243 54.1306 28.4443 54.0626 28.3603C53.9986 28.2723 53.9666 28.1743 53.9666 28.0663C53.9666 27.9463 54.0126 27.8423 54.1046 27.7543C54.1966 27.6623 54.3406 27.6163 54.5366 27.6163C54.6766 27.6163 54.7986 27.6443 54.9026 27.7003C55.0106 27.7523 55.1046 27.8243 55.1846 27.9163C55.2646 28.0043 55.3306 28.1003 55.3826 28.2043L55.9586 27.8803C55.8866 27.7323 55.7866 27.5903 55.6586 27.4543C55.5346 27.3183 55.3806 27.2063 55.1966 27.1183C55.0126 27.0303 54.7966 26.9863 54.5486 26.9863C54.2966 26.9863 54.0706 27.0343 53.8706 27.1303C53.6746 27.2223 53.5186 27.3543 53.4026 27.5263C53.2866 27.6943 53.2286 27.8903 53.2286 28.1143C53.2286 28.3103 53.2666 28.4783 53.3426 28.6183C53.4186 28.7543 53.5146 28.8703 53.6306 28.9663C53.7466 29.0583 53.8686 29.1363 53.9966 29.2003C54.1246 29.2603 54.2406 29.3083 54.3446 29.3443C54.5206 29.4083 54.6746 29.4743 54.8066 29.5423C54.9426 29.6063 55.0486 29.6863 55.1246 29.7823C55.2006 29.8743 55.2386 29.9983 55.2386 30.1543C55.2386 30.3183 55.1786 30.4523 55.0586 30.5563C54.9386 30.6603 54.7826 30.7123 54.5906 30.7123C54.4306 30.7123 54.2866 30.6803 54.1586 30.6163C54.0306 30.5483 53.9126 30.4543 53.8046 30.3343C53.7006 30.2103 53.6026 30.0683 53.5106 29.9083ZM59.03 29.1583C59.03 28.8583 59.096 28.5983 59.228 28.3783C59.364 28.1543 59.54 27.9823 59.756 27.8623C59.976 27.7383 60.214 27.6763 60.47 27.6763C60.67 27.6763 60.85 27.7023 61.01 27.7543C61.17 27.8063 61.314 27.8783 61.442 27.9703C61.574 28.0583 61.688 28.1583 61.784 28.2703V27.4303C61.608 27.2863 61.418 27.1763 61.214 27.1003C61.01 27.0243 60.754 26.9863 60.446 26.9863C60.138 26.9863 59.85 27.0383 59.582 27.1423C59.318 27.2463 59.088 27.3963 58.892 27.5923C58.696 27.7883 58.542 28.0203 58.43 28.2883C58.322 28.5523 58.268 28.8423 58.268 29.1583C58.268 29.4743 58.322 29.7663 58.43 30.0343C58.542 30.2983 58.696 30.5283 58.892 30.7243C59.088 30.9203 59.318 31.0703 59.582 31.1743C59.85 31.2783 60.138 31.3303 60.446 31.3303C60.754 31.3303 61.01 31.2923 61.214 31.2163C61.418 31.1403 61.608 31.0303 61.784 30.8863V30.0463C61.688 30.1583 61.574 30.2603 61.442 30.3523C61.314 30.4403 61.17 30.5103 61.01 30.5623C60.85 30.6143 60.67 30.6403 60.47 30.6403C60.214 30.6403 59.976 30.5803 59.756 30.4603C59.54 30.3363 59.364 30.1623 59.228 29.9383C59.096 29.7143 59.03 29.4543 59.03 29.1583ZM64.4553 27.0583V31.2583H65.1693V27.0583H64.4553Z"
                fill="black"
              />
              <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M41.6562 14.4062L40.6875 0H39.5938C39.3646 1 38.9792 1.78125 38.4375 2.34375C38.0208 2.73958 37.5312 2.9375 36.9688 2.9375C36.5938 2.9375 35.9688 2.70833 35.0938 2.25C32.1146 0.75 29.0938 0 26.0312 0C22.0938 0 18.4583 0.979167 15.125 2.9375C11.8125 4.875 9.20833 7.61458 7.3125 11.1562C5.41667 14.6979 4.46875 18.5833 4.46875 22.8125C4.46875 23.3348 4.48298 23.8502 4.51143 24.3589H11.6255C11.6043 23.873 11.5938 23.3784 11.5938 22.875C11.5938 18.2292 12.2396 14.3438 13.5312 11.2188C14.8438 8.09375 16.6354 5.82292 18.9062 4.40625C21.1771 2.96875 23.7188 2.25 26.5312 2.25C29.8854 2.25 32.7604 3.19792 35.1562 5.09375C37.5521 6.98958 39.3958 10.0938 40.6875 14.4062H41.6562ZM41.356 33.194H42.2961L42.625 33.4062C40.5 37.1771 38.0208 39.9375 35.1875 41.6875C32.3542 43.4375 28.9896 44.3125 25.0938 44.3125C18.0729 44.3125 12.6354 41.7083 8.78125 36.5C8.0012 35.4486 7.32697 34.3466 6.75856 33.194H13.5953C14.8223 35.8359 16.6135 37.8754 18.9688 39.3125C21.4479 40.8125 24.2708 41.5625 27.4375 41.5625C30.1875 41.5625 32.6146 40.9792 34.7188 39.8125C36.7391 38.6723 38.9515 36.4662 41.356 33.194Z"
                fill="#005E93"
              />
              <path
                fillRule="evenodd"
                clipRule="evenodd"
                d="M51.6924 17.4731V18.3403H52.8877C54.0908 18.3403 54.9971 18.6841 55.6064 19.3716C56.0439 19.8716 56.2627 21.1138 56.2627 23.0981V25.1832H58.3721V23.2856C58.3721 21.52 58.5361 20.395 58.8643 19.9106C59.5361 18.8638 60.4971 18.3403 61.7471 18.3403H62.9424V17.4731H51.6924ZM58.3721 35.2422H56.2627V35.9653C56.2627 39.3403 55.958 41.7388 55.3486 43.1606C54.7549 44.5669 53.6377 45.7231 51.9971 46.6294C50.3564 47.5356 48.4971 47.9888 46.4189 47.9888C44.7939 47.9888 43.4189 47.6997 42.2939 47.1216C41.1846 46.5435 40.333 45.8091 39.7393 44.9185C39.1455 44.0278 38.7314 42.7856 38.4971 41.1919C38.2783 39.5981 38.1689 38.1841 38.1689 36.9497V35.2422H33.6689V35.52C33.6689 39.3481 33.9189 41.9575 34.4189 43.3481C35.1689 45.3794 36.4424 46.9966 38.2393 48.1997C40.0361 49.4028 42.6689 50.0044 46.1377 50.0044C49.3252 50.0044 51.8408 49.3794 53.6846 48.1294C55.5439 46.8638 56.7861 45.356 57.4111 43.606C58.0518 41.8403 58.3721 39.3638 58.3721 36.1763V35.2422ZM33.6689 25.1832V23.0981C33.6689 21.145 33.3955 19.8638 32.8486 19.2544C32.3174 18.645 31.4502 18.3403 30.2471 18.3403H29.0518V17.4731H42.7861V18.3403H41.5674C40.2549 18.3403 39.3174 18.7544 38.7549 19.5825C38.3643 20.145 38.1689 21.3169 38.1689 23.0981V25.1832H33.6689Z"
                fill="#FDC415"
              />
            </svg>
          </IconButton>
          <div>
            <Button variant="text" onClick={() => navigate("/main")}>
              หน้าแรก
            </Button>
            {token && (
              <Button variant="text" onClick={() => navigate("/project-info")}>
                ข้อมูลโครงงาน
              </Button>
            )}
            <Button variant="text" onClick={() => navigate("/summary-table")}>
              ตารางสรุป
            </Button>
            <Button variant="text" onClick={() => navigate("/download-files")}>
              เอกสารสำหรับดาวน์โหลด
            </Button>
          </div>
          
          {!token? (
            <Button variant="contained" onClick={() => navigate("/sign-in")}>
              เข้าสู่ระบบ
            </Button>
          ):(
            <div>
              <Button
                ref={anchorRef}
                id="composition-button"
                variant="contained"
                aria-controls={open ? "composition-menu" : undefined}
                aria-expanded={open ? "true" : undefined}
                aria-haspopup="true"
                onClick={handleToggle}
              >
                {localStorage.getItem("username")}
              </Button>
              <Popper
                open={open}
                anchorEl={anchorRef.current}
                role={undefined}
                placement="bottom-end"
                transition
                disablePortal
                style={{ zIndex: 1301 }}
              >
                {({ TransitionProps, placement }) => (
                  <Grow
                    {...TransitionProps}
                    style={{
                      transformOrigin:
                        placement === "bottom-start"
                          ? "left top"
                          : "left bottom",
                    }}
                  >
                    <Paper>
                      <ClickAwayListener onClickAway={handleClose}>
                        <MenuList
                          autoFocusItem={open}
                          id="composition-menu"
                          aria-labelledby="composition-button"
                          onKeyDown={handleListKeyDown}
                        >
                          <MenuItem
                            onClick={() => {
                              handleClose;
                              navigate("/profile");
                            }}
                            autoFocus={true}
                          >
                            ข้อมูลผู้ใช้งาน
                          </MenuItem>
                          <MenuItem
                            onClick={signOut}
                            autoFocus={true}
                          >
                            ออกจากระบบ
                          </MenuItem>
                        </MenuList>
                      </ClickAwayListener>
                    </Paper>
                  </Grow>
                )}
              </Popper>
            </div>
          )}
        </Toolbar>
      </Container>

      <Container
        maxWidth="xl"
        sx={{
          background: "linear-gradient(to right bottom, #0075FF, #234fbb)",
        }}
      >
        <Toolbar disableGutters>
          <div>
            <Select
              value={semesterId}
              onChange={handleOnChangeSemester}
            >
              <MenuItem value={6}>2566/3</MenuItem>
              <MenuItem value={5}>2566/2</MenuItem>
              <MenuItem value={4}>2566/1</MenuItem>
              <MenuItem value={2}>2565/2</MenuItem>
              <MenuItem value={1}>2565/1</MenuItem>
            </Select>
            <Switch checked={toggle} onChange={handleOnChangeToggle} />
            {toggle ? "project" : "proposal"}
          </div>
          <Button
            variant="outlined"
            sx={{ color: "#fff", borderColor: "#fff" }}
            onClick={() => navigate("/faq")}
          >
            FAQ
          </Button>
        </Toolbar>
      </Container>
    </AppBar>
  );
}
